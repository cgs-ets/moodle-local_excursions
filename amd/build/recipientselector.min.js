define(["jquery","core/log","core/ajax","core/templates","core/str"],function(i,n,t,r,s){"use strict";function l(e,t,o,r){var i=this;i.rootel=e,i.component="local_excursions",i.selector=t,i.role=o,i.allowmultiple=r,i.strings={},s.get_strings([{key:"activityform:recipientnoselection",component:i.component}]).then(function(e){i.strings.noselectionstr=e[0]}),r||i.rootel.addClass("allow-single")}return l.prototype.main=function(){var o,r=this;r.render(),r.rootel.on("keyup",".recipient-autocomplete",function(e){clearTimeout(o);var t=i(this);13==e.which?r.search(t):o=setTimeout(function(){r.search(t)},500)}),r.rootel.on("click",".recipient-result",function(e){e.preventDefault();e=i(this);r.add(e)}),r.rootel.on("click",".recipient-tag",function(e){e.preventDefault();e=i(this);r.remove(e)}),r.rootel.on("focus",".recipient-autocomplete",function(e){r.refocus()}),i(document).on("click",function(e){e=i(e.target);e.is(".recipient-autocomplete")||e.is(".recipient-result")||r.unfocus()})},l.prototype.add=function(e){var t,o=this,r=(o.unfocus(),o.rootel.addClass("adding-tag"),o.rootel.parent().find('input[name="'+o.selector+'json"]').first()),i=new Array;if(1==o.allowmultiple)for(r.val()&&(i=JSON.parse(r.val())),t=0;t<i.length;t++)if(i[t].idfield==e.data("idfield"))return void o.render();var n={taguid:Date.now(),idfield:e.data("idfield"),photourl:e.find("img").attr("src"),fullname:e.find("span").first().text()},n=(i.push(n),JSON.stringify(i));r.val(n),o.render()},l.prototype.remove=function(e){for(var t=this,o=(o=e.data("taguid"))||"",r=t.rootel.parent().find('input[name="'+t.selector+'json"]').first(),i=JSON.parse(r.val()),n=new Array,s=0;s<i.length;s++)(i[s].taguid||"")!=o&&n.push(i[s]);var l="";n.length?l=JSON.stringify(n):t.rootel.removeClass("has-tags"),r.val(l),e.remove()},l.prototype.render=function(){var t=this;t.rootel.removeClass("has-tags");var e=t.rootel.parent().find('input[name="'+t.selector+'json"]').first().val(),o=[];(o=e?JSON.parse(e):o).length?r.render("local_excursions/recipient_selector_tags",{tags:o}).then(function(e){t.rootel.find(".recipient-selection").html(e),t.rootel.addClass("has-tags"),t.rootel.removeClass("adding-tag"),t.rootel.find(".recipient-autocomplete").val("")}).fail(function(e){n.error(e)}):t.rootel.find(".recipient-selection").html(t.strings.noselectionstr)},l.prototype.search=function(e){var o=this;o.hasresults=!1,""!=e.val()&&(o.rootel.addClass("searching"),t.call([{methodname:"local_excursions_get_recipient_users",args:{query:e.val(),role:o.role},done:function(e){e.length?(o.hasresults=!0,r.render("local_excursions/recipient_selector_results",{users:e}).then(function(e){var t=o.rootel.find(".recipient-results");t.html(e),o.rootel.addClass("showing-results"),t.addClass("active"),o.rootel.removeClass("searching")}).fail(function(e){n.error(e)})):(o.rootel.removeClass("searching"),o.rootel.find(".recipient-results").removeClass("active"),o.rootel.removeClass("showing-results"))},fail:function(e){o.rootel.removeClass("searching"),n.error("local_excursions/recipientselector: failed to search."),n.debug(e)}}]))},l.prototype.unfocus=function(){this.rootel.find(".recipient-results").removeClass("active"),this.rootel.removeClass("showing-results")},l.prototype.refocus=function(){this.rootel.find(".recipient-autocomplete").val()&&this.hasresults&&(this.rootel.addClass("showing-results"),this.rootel.find(".recipient-results").addClass("active"))},{init:function(e,t,o){n.debug("local_excursions/recipientselector: initializing the #"+e+" recipient selector component");var r=i("#"+e).first();if(r.length)return(r=new l(r,e,t,o)).main(),r;n.error("local_excursions/recipientselector: #"+e+" root element not found!")}}});