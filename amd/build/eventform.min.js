define(["jquery","local_excursions/recipientselector","core/log","core/templates","core/ajax","core/str","core/modal_factory","core/modal_events"],function(s,e,a,t,n,i,o,l){"use strict";function r(e){var t=this;t.rootel=e,t.form=t.rootel.find('form[data-form="excursions-event"]'),t.eventid=t.form.data("eventid"),t.areastree=null,t.categoriestree=null,t.conflictCheckDone=!1,o.create({type:o.types.SAVE_CANCEL}).then(function(e){e.setTitle("Conflicts found"),e.setButtonText("cancel","Review entry"),e.setSaveButtonText("Submit anyway"),t.modal=e,t.modal.getModal().addClass("modal-xl"),t.modal.getRoot().on(l.save,function(e){t.submitForm()})}),window.addEventListener("beforeunload",function(e){console.log("UNLOAD:1")})}return r.prototype.convertFieldsToDate=function(e){return s('[name="'+e+'[year]"]').val()+"-"+s('[name="'+e+'[month]"]').val().padStart(2,"0")+"-"+s('[name="'+e+'[day]"]').val().padStart(2,"0")+" "+s('[name="'+e+'[hour]"]').val().padStart(2,"0")+":"+s('[name="'+e+'[minute]"]').val().padStart(2,"0")},r.prototype.main=function(){var c=this,t=(c.owner=e.init("owner","staff",0),c.watchCategories(),document.getElementById("btn-delete"));t&&t.addEventListener("click",e=>{e.preventDefault();e=t.dataset.eventid;n.call([{methodname:"local_excursions_formcontrol",args:{action:"delete_event",data:e},done:function(e){document.getElementById("id_cancel").click()}}])}),c.rootel.on("click","#id_submitbutton",function(e){var t;c.conflictCheckDone||(e.preventDefault(),e=c.convertFieldsToDate("timestart"),t=c.convertFieldsToDate("timeend"),n.call([{methodname:"local_excursions_formcontrol",args:{action:"check_conflicts",data:JSON.stringify({timestart:e,timeend:t,eventid:c.eventid})},done:function(e){var t,a,n,i,o,l,r,e=JSON.parse(e);console.log(e),c.form.addClass("conflicts-checked"),e.conflicts.length?(r='<div class="conflicts-wrap"><div class="alert alert-warning"><strong>Review the conflicts below and consider whether your event needs to be moved before you continue.</strong></div><div class="table-heading"><b class="table-heading-label">Event summary</b></div><table><tr><th>Title</th><th>Dates</th><th>Location</th><th>Areas</th><th>Owner</th></tr>',t=s('input[name="activityname"]').val(),a=s('input[name="location"]').val(),n="<div>"+s('[name="timestart[hour]"]').val().padStart(2,"0")+":"+s('[name="timestart[minute]"]').val().padStart(2,"0")+"</div><div><small>"+s('[name="timestart[day]"]').val().padStart(2,"0")+"-"+s('[name="timestart[month]"]').val().padStart(2,"0")+"-"+s('[name="timestart[year]"]').val()+"</small></div>",i="<div>"+s('[name="timeend[hour]"]').val().padStart(2,"0")+":"+s('[name="timeend[minute]"]').val().padStart(2,"0")+"</div><div><small>"+s('[name="timeend[day]"]').val().padStart(2,"0")+"-"+s('[name="timeend[month]"]').val().padStart(2,"0")+"-"+s('[name="timeend[year]"]').val()+"</small></div>",o=(o=(o=(o=s('input[name="categoriesjson"]').first().val())?JSON.parse(o):[]).map(function(e){return e.split("/")})).flat(1),o="<ul>"+(o=[...new Set(o)]).map(function(e){return"<li>"+e+"</li>"}).join("")+"</ul>",l=s('input[name="ownerjson"]').first().val(),r=(r=(r=(r+="<tr><td>"+t+"</td>")+'<td><div style="display:flex;gap:20px;"><div>'+n+"</div><div>"+i+"</div></div></td><td>"+a+"</td>")+"<td>"+o+"</td><td>"+("<div>"+JSON.parse(l).map(function(e){return'<img class="rounded-circle" height="18" src="'+e.photourl+'"> <span>'+e.fullname+"</span>"})+"</div>")+"</td></tr></table><br>")+'<div class="table-heading"><b class="table-heading-label">Conflicting events</b></div>'+e.html,c.modal.setBody(r+="</div>"),c.modal.show()):c.submitForm()},fail:function(e){c.form.addClass("conflicts-checked"),a.error("local_excursions/eventform: failed to check conflicts."),a.debug(e),c.submitForm()}}]))}),c.getDayCycle(["timestart","timeend"]),c.initDatesChanged()},r.prototype.getDayCycle=function(a){for(let t=0;t<a.length;t++){var e=this.convertFieldsToDate(a[t]);n.call([{methodname:"local_excursions_formcontrol",args:{action:"get_day_cycle",data:JSON.stringify({datetime:e})},done:function(e){e=JSON.parse(e);s("#daycycle-"+a[t]).html(e)}}])}},r.prototype.submitForm=function(){this.modal.hide(),this.conflictCheckDone=!0,s("#id_submitbutton").click()},r.prototype.watchCategories=function(){var t=this;s('input[name="categories"]').change(function(e){console.log(e.currentTarget.checked),t.generateCategoriesJSON()})},r.prototype.generateCategoriesJSON=function(){for(var e=document.getElementsByName("categories"),t=[],a=0;a<e.length;a++)e[a].checked&&t.push(e[a].value);s('input[name="categoriesjson"]').val(JSON.stringify(t))},r.prototype.initDatesChanged=function(){var e=this;s('select[name="timestart[day]"]').change(function(){e.getDayCycle(["timestart"])}),s('select[name="timestart[month]"]').change(function(){e.getDayCycle(["timestart"])}),s('select[name="timestart[year]"]').change(function(){e.getDayCycle(["timestart"])}),s('select[name="timeend[day]"]').change(function(){e.getDayCycle(["timeend"])}),s('select[name="timeend[month]"]').change(function(){e.getDayCycle(["timeend"])}),s('select[name="timeend[year]"]').change(function(){e.getDayCycle(["timeend"])})},{init:function(){a.debug("local_excursions/event: initializing");var e=s("#page-local-excursions-event");e.length?new r(e).main():a.error("#page-local-excursions-event not found!")}}});