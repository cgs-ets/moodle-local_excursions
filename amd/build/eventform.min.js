define(["jquery","local_excursions/recipientselector","core/log","core/templates","core/ajax","core/str","core/modal_factory","core/modal_events"],function(n,e,o,t,r,a,i,s){"use strict";function c(e){var t=this;t.rootel=e,t.form=t.rootel.find('form[data-form="excursions-event"]'),t.areastree=null,t.categoriestree=null,i.create({type:i.types.SAVE_CANCEL}).then(function(e){e.setTitle("Conflicts found"),e.setSaveButtonText("Submit anyway"),t.modal=e,t.modal.getModal().addClass("modal-xl"),t.modal.getRoot().on(s.save,function(e){t.submitForm()})}),window.addEventListener("beforeunload",function(e){e.stopImmediatePropagation()})}return c.prototype.main=function(){var a=this;a.renderAreasFromJSON(),a.owner=e.init("owner","staff",0),"undefined"!=typeof Tree&&"undefined"!=typeof calcategories&&(a.categoriestree=new Tree(".categoriescontainer",{data:calcategories,closeDepth:1,onChange:function(){n('input[name="categories"]').val(JSON.stringify(this.values))}})),"undefined"!=typeof Tree&&"undefined"!=typeof eventareas&&(a.areastree=new Tree(".areascontainer",{data:eventareas,closeDepth:3,onChange:function(){n('input[name="areasjson"]').val(JSON.stringify(this.values)),console.log(this.values)}})),a.rootel.on("click",'input[name="cancel"]',function(e){a.form.find('[name="action"]').val("cancel")}),a.rootel.on("click",'input[name="delete"]',function(e){a.form.find('[name="action"]').val("delete")}),a.rootel.on("click","#id_submitbutton",function(e){e.preventDefault();var e=n('[name="timestart[year]"]').val()+"-"+n('[name="timestart[month]"]').val().padStart(2,"0")+"-"+n('[name="timestart[day]"]').val().padStart(2,"0")+" "+n('[name="timestart[hour]"]').val().padStart(2,"0")+":"+n('[name="timestart[minute]"]').val().padStart(2,"0"),t=n('[name="timeend[year]"]').val()+"-"+n('[name="timeend[month]"]').val().padStart(2,"0")+"-"+n('[name="timeend[day]"]').val().padStart(2,"0")+" "+n('[name="timeend[hour]"]').val().padStart(2,"0")+":"+n('[name="timeend[minute]"]').val().padStart(2,"0");r.call([{methodname:"local_excursions_formcontrol",args:{action:"check_conflicts",data:JSON.stringify({timestart:e,timeend:t})},done:function(e){e=JSON.parse(e);console.log(e),a.form.addClass("conflicts-checked"),e.hasConflicts?(a.modal.setBody(e.html),a.modal.show()):a.submitForm()},fail:function(e){a.form.addClass("conflicts-checked"),o.error("local_excursions/eventform: failed to check conflicts."),o.debug(e),a.submitForm()}}])})},c.prototype.submitForm=function(){this.modal.hide(),this.form.submit()},c.prototype.renderAreasFromJSON=function(){},{init:function(){o.debug("local_excursions/event: initializing");var e=n("#page-local-excursions-event");e.length?new c(e).main():o.error("#page-local-excursions-event not found!")}}});