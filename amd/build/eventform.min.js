define(["jquery","local_excursions/recipientselector","core/log","core/templates","core/ajax","core/str","core/modal_factory","core/modal_events"],function(d,e,n,t,a,o,i,l){"use strict";function r(e){var t=this;t.rootel=e,t.form=t.rootel.find('form[data-form="excursions-event"]'),t.eventid=t.form.data("eventid"),t.areastree=null,t.categoriestree=null,t.conflictCheckDone=!1,i.create({type:i.types.SAVE_CANCEL}).then(function(e){e.setTitle("Conflicts found"),e.setButtonText("cancel","Review entry"),e.setSaveButtonText("Submit anyway"),t.modal=e,t.modal.getModal().addClass("modal-xl"),t.modal.getRoot().on(l.save,function(e){t.submitForm()})}),window.addEventListener("beforeunload",function(e){console.log("UNLOAD:1")})}return r.prototype.convertFieldsToDate=function(e){return d('[name="'+e+'[year]"]').val()+"-"+d('[name="'+e+'[month]"]').val().padStart(2,"0")+"-"+d('[name="'+e+'[day]"]').val().padStart(2,"0")+" "+d('[name="'+e+'[hour]"]').val().padStart(2,"0")+":"+d('[name="'+e+'[minute]"]').val().padStart(2,"0")},r.prototype.main=function(){var c=this,t=(c.owner=e.init("owner","staff",0),c.rootel.on("change",'input[name="assessment"]',function(e){d(this).is(":checked")?(c.rootel.find(".entry-type-heading").hide(),c.rootel.find("#fgroup_id_entrytype").hide(),d("input:radio[name=entrytype]").filter("[value=event]").prop("checked",!0)):(c.rootel.find(".entry-type-heading").show(),c.rootel.find("#fgroup_id_entrytype").show())}),c.watchCategories(),c.categoryChanged(),document.getElementById("btn-delete"));t&&t.addEventListener("click",e=>{e.preventDefault();e=t.dataset.eventid;a.call([{methodname:"local_excursions_formcontrol",args:{action:"delete_event",data:e},done:function(e){document.getElementById("id_cancel").click()}}])}),c.rootel.on("click","#id_submitbutton",function(e){var t;c.conflictCheckDone||(e.preventDefault(),e=c.convertFieldsToDate("timestart"),t=c.convertFieldsToDate("timeend"),a.call([{methodname:"local_excursions_formcontrol",args:{action:"check_conflicts",data:JSON.stringify({timestart:e,timeend:t,eventid:c.eventid})},done:function(e){var t,n,a,o,i,l,r,e=JSON.parse(e);console.log(e),c.form.addClass("conflicts-checked"),e.conflicts.length?(r='<div class="conflicts-wrap"><div class="alert alert-warning"><strong>Review the conflicts below and consider whether your event needs to be moved before you continue.</strong></div><div class="table-heading"><b class="table-heading-label">Event summary</b></div><table><tr><th>Title</th><th>Dates</th><th>Location</th><th>Areas</th><th>Owner</th></tr>',t=d('input[name="activityname"]').val(),n=d('input[name="location"]').val(),a="<div>"+d('[name="timestart[hour]"]').val().padStart(2,"0")+":"+d('[name="timestart[minute]"]').val().padStart(2,"0")+"</div><div><small>"+d('[name="timestart[day]"]').val().padStart(2,"0")+"-"+d('[name="timestart[month]"]').val().padStart(2,"0")+"-"+d('[name="timestart[year]"]').val()+"</small></div>",o="<div>"+d('[name="timeend[hour]"]').val().padStart(2,"0")+":"+d('[name="timeend[minute]"]').val().padStart(2,"0")+"</div><div><small>"+d('[name="timeend[day]"]').val().padStart(2,"0")+"-"+d('[name="timeend[month]"]').val().padStart(2,"0")+"-"+d('[name="timeend[year]"]').val()+"</small></div>",i=(i=(i=(i=d('input[name="categoriesjson"]').first().val())?JSON.parse(i):[]).map(function(e){return e.split("/")})).flat(1),i="<ul>"+(i=[...new Set(i)]).map(function(e){return"<li>"+e+"</li>"}).join("")+"</ul>",l=d('input[name="ownerjson"]').first().val(),r=(r=(r=(r+="<tr><td>"+t+"</td>")+'<td><div style="display:flex;gap:20px;"><div>'+a+"</div><div>"+o+"</div></div></td><td>"+n+"</td>")+"<td>"+i+"</td><td>"+("<div>"+JSON.parse(l).map(function(e){return'<img class="rounded-circle" height="18" src="'+e.photourl+'"> <span>'+e.fullname+"</span>"})+"</div>")+"</td></tr></table><br>")+'<div class="table-heading"><b class="table-heading-label">Conflicting events</b></div>'+e.html,c.modal.setBody(r+="</div>"),c.modal.show()):c.submitForm()},fail:function(e){c.form.addClass("conflicts-checked"),n.error("local_excursions/eventform: failed to check conflicts."),n.debug(e),c.submitForm()}}]))}),c.getDayCycle(["timestart","timeend"]),c.initDatesChanged()},r.prototype.getDayCycle=function(n){for(let t=0;t<n.length;t++){var e=this.convertFieldsToDate(n[t]);a.call([{methodname:"local_excursions_formcontrol",args:{action:"get_day_cycle",data:JSON.stringify({datetime:e})},done:function(e){e=JSON.parse(e);d("#daycycle-"+n[t]).html(e)}}])}},r.prototype.submitForm=function(){this.modal.hide(),this.conflictCheckDone=!0,d("#id_submitbutton").click()},r.prototype.watchCategories=function(){var t=this;d('input[name="categories"]').change(function(e){t.categoryChanged(this)})},r.prototype.categoryChanged=function(e){for(var t=this,n=(e&&(e.checked?(i=d(e).parent().children(":first")).checked||"Primary School"==i.val()||i.prop("checked",!0):d(e).parent().children(":not(:first):checked").length&&!(i=d(e).parent().children(":first")).checked&&"Primary School"!=i.val()&&i.prop("checked",!0)),document.getElementsByName("categories")),a=[],o=0;o<n.length;o++)n[o].checked&&a.push(n[o].value);d('input[name="categoriesjson"]').val(JSON.stringify(a));(a.includes("Whole School/Website External")||a.includes("Whole School/Alumni Website")||a.includes("Primary School/Website External")||a.includes("Primary School/Alumni Website")||a.includes("Senior School/Website External")||a.includes("Senior School/Alumni Website"))&&(e=d("input:checkbox[name=displaypublic]")).prop("checked",!0);var i=a.includes("Whole School/CGS Board");if(!a.length||i?t.rootel.find("#id_displaypublic").closest(".form-group").hide():t.rootel.find("#id_displaypublic").closest(".form-group").show(),console.log(a.length),1<a.length){var l=t.rootel.find("#fitem_id_colourselect select");l.empty();for(o=0;o<a.length;o++){var r=document.createElement("option");r.value=r.innerHTML=a[o],l.append(r)}t.rootel.find("#fitem_id_colourselect").show(),l.val(l.data("selected"))}else t.rootel.find("#fitem_id_colourselect").hide()},r.prototype.initDatesChanged=function(){var e=this;d('select[name="timestart[day]"]').change(function(){e.getDayCycle(["timestart"])}),d('select[name="timestart[month]"]').change(function(){e.getDayCycle(["timestart"])}),d('select[name="timestart[year]"]').change(function(){e.getDayCycle(["timestart"])}),d('select[name="timeend[day]"]').change(function(){e.getDayCycle(["timeend"])}),d('select[name="timeend[month]"]').change(function(){e.getDayCycle(["timeend"])}),d('select[name="timeend[year]"]').change(function(){e.getDayCycle(["timeend"])})},r.prototype.initCategorySelect=function(){},{init:function(){n.debug("local_excursions/event: initializing");var e=d("#page-local-excursions-event");e.length?new r(e).main():n.error("#page-local-excursions-event not found!")}}});