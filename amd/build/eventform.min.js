define(["jquery","local_excursions/recipientselector","core/log","core/templates","core/ajax","core/str","core/modal_factory","core/modal_events"],function(o,e,a,t,r,n,i,s){"use strict";function c(e){var t=this;t.rootel=e,t.form=t.rootel.find('form[data-form="excursions-event"]'),t.areastree=null,t.categoriestree=null,i.create({type:i.types.SAVE_CANCEL}).then(function(e){e.setTitle("Conflicts found"),e.setSaveButtonText("Submit anyway"),t.modal=e,t.modal.getModal().addClass("modal-xl"),t.modal.getRoot().on(s.save,function(e){t.submitForm()})}),window.addEventListener("beforeunload",function(e){e.stopImmediatePropagation()})}return c.prototype.main=function(){var n=this;n.renderAreasFromJSON(),n.owner=e.init("owner","staff",0),"undefined"!=typeof Tree&&"undefined"!=typeof calcategories&&(n.categoriestree=new Tree(".categoriescontainer",{data:calcategories,closeDepth:1,onChange:function(){o('input[name="categoriesjson"]').val(JSON.stringify(this.values))}})),"undefined"!=typeof Tree&&"undefined"!=typeof eventareas&&(n.areastree=new Tree(".areascontainer",{data:eventareas,closeDepth:3,onChange:function(){o('input[name="areasjson"]').val(JSON.stringify(this.values)),console.log(this.values)}})),n.rootel.on("click",'input[name="cancel"]',function(e){n.form.find('[name="action"]').val("cancel")}),n.rootel.on("click",'input[name="delete"]',function(e){n.form.find('[name="action"]').val("delete")}),n.rootel.on("click","#id_submitbutton",function(e){e.preventDefault();var e=o('[name="timestart[year]"]').val()+"-"+o('[name="timestart[month]"]').val().padStart(2,"0")+"-"+o('[name="timestart[day]"]').val().padStart(2,"0")+" "+o('[name="timestart[hour]"]').val().padStart(2,"0")+":"+o('[name="timestart[minute]"]').val().padStart(2,"0"),t=o('[name="timeend[year]"]').val()+"-"+o('[name="timeend[month]"]').val().padStart(2,"0")+"-"+o('[name="timeend[day]"]').val().padStart(2,"0")+" "+o('[name="timeend[hour]"]').val().padStart(2,"0")+":"+o('[name="timeend[minute]"]').val().padStart(2,"0");r.call([{methodname:"local_excursions_formcontrol",args:{action:"check_conflicts",data:JSON.stringify({timestart:e,timeend:t})},done:function(e){var t,e=JSON.parse(e);console.log(e),n.form.addClass("conflicts-checked"),e.hasConflicts?(t='<div class="conflicts-wrap"><div class="alert alert-warning"><strong>Review the conflicts below and consider whether your event needs to be moved before you continue.</strong></div>',t+=e.html,n.modal.setBody(t+="</div>"),n.modal.show()):n.submitForm()},fail:function(e){n.form.addClass("conflicts-checked"),a.error("local_excursions/eventform: failed to check conflicts."),a.debug(e),n.submitForm()}}])})},c.prototype.submitForm=function(){this.modal.hide(),this.form.submit()},c.prototype.renderAreasFromJSON=function(){},c.prototype.renderCategoriesFromJSON=function(){},{init:function(){a.debug("local_excursions/event: initializing");var e=o("#page-local-excursions-event");e.length?new c(e).main():a.error("#page-local-excursions-event not found!")}}});