define(["jquery","local_excursions/recipientselector","core/log","core/templates","core/ajax","core/str","core/modal_factory","core/modal_events"],function(l,r,i,e,u,t,n,a){"use strict";function c(e){var t=this;t.rootel=e,t.form=t.rootel.find('form[data-form="excursions-event"]'),t.eventid=t.form.data("eventid"),t.areastree=null,t.categoriestree=null,t.conflictCheckDone=!1,n.create({type:n.types.SAVE_CANCEL}).then(function(e){e.setTitle("Conflicts found"),e.setButtonText("cancel","Review entry"),e.setSaveButtonText("Submit anyway"),t.modal=e,t.modal.getModal().addClass("modal-xl"),t.modal.getRoot().on(a.save,function(e){t.submitForm()})}),window.addEventListener("beforeunload",function(e){console.log("UNLOAD:1")})}return c.prototype.convertFieldsToDate=function(e){return l('[name="'+e+'[year]"]').val()+"-"+l('[name="'+e+'[month]"]').val().padStart(2,"0")+"-"+l('[name="'+e+'[day]"]').val().padStart(2,"0")+" "+l('[name="'+e+'[hour]"]').val().padStart(2,"0")+":"+l('[name="'+e+'[minute]"]').val().padStart(2,"0")},c.prototype.main=function(){var e,t,n,a,o=this;o.owner=r.init("owner","staff",0),"undefined"!=typeof Tree&&"undefined"!=typeof calcategories&&(n=(e=l('input[name="categoriesjson"]').first()).val(),a=n?JSON.parse(n):[],o.categoriestree=new Tree(".categoriescontainer",{data:calcategories,closeDepth:1,loaded:function(){this.values=a},onChange:function(){e.val(JSON.stringify(this.values))}})),"undefined"!=typeof Tree&&"undefined"!=typeof eventareas&&(n=(t=l('input[name="areasjson"]').first()).val(),a=n?JSON.parse(n):[],o.areastree=new Tree(".areascontainer",{data:eventareas,closeDepth:3,loaded:function(){this.values=a},onChange:function(){t.val(JSON.stringify(this.values))}})),o.rootel.on("click",'input[name="cancel"]',function(e){o.form.find('[name="action"]').val("cancel")}),o.rootel.on("click",'input[name="delete"]',function(e){o.form.find('[name="action"]').val("delete")}),o.rootel.on("click","#id_submitbutton",function(e){var t,n,a,r,c;o.conflictCheckDone||(e.preventDefault(),e=o.convertFieldsToDate("timestart"),t=o.convertFieldsToDate("timeend"),(n=l('input[name="recurring"]:checked').val())&&(a=l('input[name="recurringpattern"]:checked').val(),r=l('input[name="recurringdailypattern"]:checked').val(),c=o.convertFieldsToDate("recuruntil")),u.call([{methodname:"local_excursions_formcontrol",args:{action:"check_conflicts",data:JSON.stringify({timestart:e,timeend:t,eventid:o.eventid,recurringsettings:n?{recurring:n,recurringpattern:a,recurringdailypattern:r,recuruntil:c}:null})},done:function(e){var t,n,a,r,c,i,e=JSON.parse(e);console.log(e),o.form.addClass("conflicts-checked"),e.conflicts.length?(i='<div class="conflicts-wrap"><div class="alert alert-warning"><strong>Review the conflicts below and consider whether your event needs to be moved before you continue.</strong></div><div class="table-heading"><b class="table-heading-label">Event summary</b></div><table><tr><th>Title</th><th>Start</th><th>End</th><th>Areas</th><th>Owner</th></tr>',t=l('input[name="activityname"]').val(),n="<div>"+l('[name="timestart[hour]"]').val().padStart(2,"0")+":"+l('[name="timestart[minute]"]').val().padStart(2,"0")+"</div><div><small>"+l('[name="timestart[day]"]').val().padStart(2,"0")+"-"+l('[name="timestart[month]"]').val().padStart(2,"0")+"-"+l('[name="timestart[year]"]').val()+"</small></div>",a="<div>"+l('[name="timeend[hour]"]').val().padStart(2,"0")+":"+l('[name="timeend[minute]"]').val().padStart(2,"0")+"</div><div><small>"+l('[name="timeend[day]"]').val().padStart(2,"0")+"-"+l('[name="timeend[month]"]').val().padStart(2,"0")+"-"+l('[name="timeend[year]"]').val()+"</small></div>",r="<ul>"+((r=l('input[name="areasjson"]').first().val())?JSON.parse(r):[]).map(function(e){return"<li>"+e+"</li>"}).join("")+"</ul>",c=l('input[name="ownerjson"]').first().val(),i=(i=i+("<tr><td>"+t+"</td><td>"+n+"</td><td>"+a+"</td><td>"+r+"</td><td>"+("<div>"+JSON.parse(c).map(function(e){return'<img class="rounded-circle" height="18" src="'+e.photourl+'"> <span>'+e.fullname+"</span>"})+"</div>"))+"</td></tr></table><br>")+'<div class="table-heading"><b class="table-heading-label">Conflicting events</b></div>'+e.html,o.modal.setBody(i+="</div>"),o.modal.show()):o.submitForm()},fail:function(e){o.form.addClass("conflicts-checked"),i.error("local_excursions/eventform: failed to check conflicts."),i.debug(e),o.submitForm()}}]))}),o.setupCheckRecurring()},c.prototype.checkRecurring=function(){var e,t,n,a=this,r=(l("#calculated-dates").html(""),l('input[name="editseries"]:checked').val());"event"!=r&&l('input[name="recurring"]:checked').val()&&(r=a.convertFieldsToDate("timestart"),e=a.convertFieldsToDate("timeend"),t=l('input[name="recurringpattern"]:checked').val(),n=l('input[name="recurringdailypattern"]:checked').val(),a=a.convertFieldsToDate("recuruntil"),u.call([{methodname:"local_excursions_formcontrol",args:{action:"expand_dates",data:JSON.stringify({recurring:{recurringdailypattern:n,recurringpattern:t,recuruntil:a},timestart:r,timeend:e})},done:function(e){let t=JSON.parse(e);if(void 0!==t.datesReadable&&t.datesReadable.length){let e=t.datesReadable.map(e=>"<li>"+e.start+" - "+e.end+"</li>");l("#calculated-dates").html("The following occurrences will be created: <br><ul>"+e.join(" ")+"</ul>")}}}]))},c.prototype.submitForm=function(){this.modal.hide(),this.conflictCheckDone=!0,l("#id_submitbutton").click()},c.prototype.setupCheckRecurring=function(){var e=this;l('input[name="editseries"]').change(function(){e.checkRecurring()}),l('input[name="recurring"]').change(function(){e.checkRecurring()}),l('input[name="recurringpattern"]').change(function(){e.checkRecurring()}),l('input[name="recurringdailypattern"]').change(function(){e.checkRecurring()}),l('select[name="recuruntil[day]"]').change(function(){e.checkRecurring()}),l('select[name="recuruntil[month]"]').change(function(){e.checkRecurring()}),l('select[name="recuruntil[year]"]').change(function(){e.checkRecurring()}),l('select[name="recuruntil[hour]"]').change(function(){e.checkRecurring()}),l('select[name="recuruntil[minute]"]').change(function(){e.checkRecurring()}),l('select[name="timestart[day]"]').change(function(){e.checkRecurring()}),l('select[name="timestart[month]"]').change(function(){e.checkRecurring()}),l('select[name="timestart[year]"]').change(function(){e.checkRecurring()}),l('select[name="timestart[hour]"]').change(function(){e.checkRecurring()}),l('select[name="timestart[minute]"]').change(function(){e.checkRecurring()}),l('select[name="timeend[day]"]').change(function(){e.checkRecurring()}),l('select[name="timeend[month]"]').change(function(){e.checkRecurring()}),l('select[name="timeend[year]"]').change(function(){e.checkRecurring()}),l('select[name="timeend[hour]"]').change(function(){e.checkRecurring()}),l('select[name="timeend[minute]"]').change(function(){e.checkRecurring()})},{init:function(){i.debug("local_excursions/event: initializing");var e=l("#page-local-excursions-event");e.length?new c(e).main():i.error("#page-local-excursions-event not found!")}}});