define(["jquery","local_excursions/recipientselector","core/log","core/templates","core/ajax","core/str","core/modal_factory","core/modal_events"],function(s,e,n,t,a,i,o,r){"use strict";function c(e){var t=this;t.rootel=e,t.form=t.rootel.find('form[data-form="excursions-event"]'),t.eventid=t.form.data("eventid"),t.areastree=null,t.categoriestree=null,t.conflictCheckDone=!1,o.create({type:o.types.SAVE_CANCEL}).then(function(e){e.setTitle("Conflicts found"),e.setButtonText("cancel","Review entry"),e.setSaveButtonText("Submit anyway"),t.modal=e,t.modal.getModal().addClass("modal-xl"),t.modal.getRoot().on(r.save,function(e){t.submitForm()})}),window.addEventListener("beforeunload",function(e){console.log("UNLOAD:1")})}return c.prototype.convertFieldsToDate=function(e){return s('[name="'+e+'[year]"]').val()+"-"+s('[name="'+e+'[month]"]').val().padStart(2,"0")+"-"+s('[name="'+e+'[day]"]').val().padStart(2,"0")+" "+s('[name="'+e+'[hour]"]').val().padStart(2,"0")+":"+s('[name="'+e+'[minute]"]').val().padStart(2,"0")},c.prototype.main=function(){var l=this,t=(l.owner=e.init("owner","staff",0),l.watchCategories(),l.generateCategoriesJSON(),document.getElementById("btn-delete"));t&&t.addEventListener("click",e=>{e.preventDefault();e=t.dataset.eventid;a.call([{methodname:"local_excursions_formcontrol",args:{action:"delete_event",data:e},done:function(e){document.getElementById("id_cancel").click()}}])}),l.rootel.on("click","#id_submitbutton",function(e){var t;l.conflictCheckDone||(e.preventDefault(),e=l.convertFieldsToDate("timestart"),t=l.convertFieldsToDate("timeend"),a.call([{methodname:"local_excursions_formcontrol",args:{action:"check_conflicts",data:JSON.stringify({timestart:e,timeend:t,eventid:l.eventid})},done:function(e){var t,n,a,i,o,r,c,e=JSON.parse(e);console.log(e),l.form.addClass("conflicts-checked"),e.conflicts.length?(c='<div class="conflicts-wrap"><div class="alert alert-warning"><strong>Review the conflicts below and consider whether your event needs to be moved before you continue.</strong></div><div class="table-heading"><b class="table-heading-label">Event summary</b></div><table><tr><th>Title</th><th>Dates</th><th>Location</th><th>Areas</th><th>Owner</th></tr>',t=s('input[name="activityname"]').val(),n=s('input[name="location"]').val(),a="<div>"+s('[name="timestart[hour]"]').val().padStart(2,"0")+":"+s('[name="timestart[minute]"]').val().padStart(2,"0")+"</div><div><small>"+s('[name="timestart[day]"]').val().padStart(2,"0")+"-"+s('[name="timestart[month]"]').val().padStart(2,"0")+"-"+s('[name="timestart[year]"]').val()+"</small></div>",i="<div>"+s('[name="timeend[hour]"]').val().padStart(2,"0")+":"+s('[name="timeend[minute]"]').val().padStart(2,"0")+"</div><div><small>"+s('[name="timeend[day]"]').val().padStart(2,"0")+"-"+s('[name="timeend[month]"]').val().padStart(2,"0")+"-"+s('[name="timeend[year]"]').val()+"</small></div>",o=(o=(o=(o=s('input[name="categoriesjson"]').first().val())?JSON.parse(o):[]).map(function(e){return e.split("/")})).flat(1),o="<ul>"+(o=[...new Set(o)]).map(function(e){return"<li>"+e+"</li>"}).join("")+"</ul>",r=s('input[name="ownerjson"]').first().val(),c=(c=(c=(c+="<tr><td>"+t+"</td>")+'<td><div style="display:flex;gap:20px;"><div>'+a+"</div><div>"+i+"</div></div></td><td>"+n+"</td>")+"<td>"+o+"</td><td>"+("<div>"+JSON.parse(r).map(function(e){return'<img class="rounded-circle" height="18" src="'+e.photourl+'"> <span>'+e.fullname+"</span>"})+"</div>")+"</td></tr></table><br>")+'<div class="table-heading"><b class="table-heading-label">Conflicting events</b></div>'+e.html,l.modal.setBody(c+="</div>"),l.modal.show()):l.submitForm()},fail:function(e){l.form.addClass("conflicts-checked"),n.error("local_excursions/eventform: failed to check conflicts."),n.debug(e),l.submitForm()}}]))}),l.getDayCycle(["timestart","timeend"]),l.initDatesChanged(),l.initCategorySelect()},c.prototype.getDayCycle=function(n){for(let t=0;t<n.length;t++){var e=this.convertFieldsToDate(n[t]);a.call([{methodname:"local_excursions_formcontrol",args:{action:"get_day_cycle",data:JSON.stringify({datetime:e})},done:function(e){e=JSON.parse(e);s("#daycycle-"+n[t]).html(e)}}])}},c.prototype.submitForm=function(){this.modal.hide(),this.conflictCheckDone=!0,s("#id_submitbutton").click()},c.prototype.watchCategories=function(){var t=this;s('input[name="categories"]').change(function(e){t.generateCategoriesJSON()})},c.prototype.generateCategoriesJSON=function(){for(var e=document.getElementsByName("categories"),t=[],n=0;n<e.length;n++)e[n].checked&&t.push(e[n].value);s('input[name="categoriesjson"]').val(JSON.stringify(t));var a=t.includes("Whole School/CGS Board");!t.length||a?this.rootel.find("#id_displaypublic").closest(".form-group").hide():this.rootel.find("#id_displaypublic").closest(".form-group").show()},c.prototype.initDatesChanged=function(){var e=this;s('select[name="timestart[day]"]').change(function(){e.getDayCycle(["timestart"])}),s('select[name="timestart[month]"]').change(function(){e.getDayCycle(["timestart"])}),s('select[name="timestart[year]"]').change(function(){e.getDayCycle(["timestart"])}),s('select[name="timeend[day]"]').change(function(){e.getDayCycle(["timeend"])}),s('select[name="timeend[month]"]').change(function(){e.getDayCycle(["timeend"])}),s('select[name="timeend[year]"]').change(function(){e.getDayCycle(["timeend"])})},c.prototype.initCategorySelect=function(){s(".category-group input").change(function(){var e;this.checked?(e=s(this).parent().children(":first")).checked||e.prop("checked",!0):s(this).parent().children(":not(:first):checked").length&&!(e=s(this).parent().children(":first")).checked&&e.prop("checked",!0)})},{init:function(){n.debug("local_excursions/event: initializing");var e=s("#page-local-excursions-event");e.length?new c(e).main():n.error("#page-local-excursions-event not found!")}}});