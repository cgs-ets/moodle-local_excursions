define(["jquery","core/log","core/ajax","core/modal_factory","core/modal_events"],function(c,s,a,o,n){"use strict";function t(e){var t=this;t.rootel=e,t.eventrows=document.querySelectorAll("table.events tr.event"),t.eventrows=Array.from(t.eventrows),t.conflictignorechange=!1,o.create({type:o.types.DEFAULT}).then(function(e){e.setTitle("Conflicts found"),t.modal=e,t.modal.getModal().addClass("modal-xl"),t.modal.getModal().addClass("modal-conflicts"),t.modal.getRoot().on(n.hidden,function(){t.conflictignorechange&&(t.rootel.find(".excursions-overlay").addClass("active"),location.reload())})})}return t.prototype.main=function(){var n=this;n.eventrows.length&&n.getForNextRow(-1),n.rootel.on("change","select.page-select",function(e){var t=c(this).find(":selected").val(),o=new URLSearchParams(window.location.search);o.set("nav",t),n.rootel.find(".excursions-overlay").addClass("active"),window.location.href="//"+location.host+location.pathname+"?"+o.toString()}),n.rootel.on("click","a.page-link",function(e){e.preventDefault();e=new URLSearchParams(window.location.search);e.set("nav",c(this).data("nav")),n.rootel.find(".excursions-overlay").addClass("active"),window.location.href="//"+location.host+location.pathname+"?"+e.toString()}),n.rootel.on("change","select.filter-select",function(e){var t=c(this).find(":selected").val(),o=new URLSearchParams(window.location.search);o.set(c(this).attr("name"),t),n.rootel.find(".excursions-overlay").addClass("active"),window.location.href="//"+location.host+location.pathname+"?"+o.toString()}),document.querySelectorAll(".btn-showconflicts").forEach(t=>{t.addEventListener("click",e=>{e.preventDefault();e=t.dataset.eventid,e=document.querySelector('tr[data-eventid="'+e+'"]');e&&(n.modal.setBody('<div class="conflicts-wrap">'+e.dataset.conflicts+"</div>"),n.modal.show(),document.querySelectorAll('.modal-conflicts input[name="status"]').forEach(e=>{e.addEventListener("change",e=>{n.conflictignorechange=!0,a.call([{methodname:"local_excursions_formcontrol",args:{action:"set_conflict_status",data:JSON.stringify({conflictid:e.currentTarget.dataset.conflictid,status:e.currentTarget.checked})}}])})}))})}),document.querySelectorAll(".cb-syncevent").forEach(e=>{e.addEventListener("change",e=>{let o=e.currentTarget.value,n=e.currentTarget.checked;a.call([{methodname:"local_excursions_formcontrol",args:{action:"set_event_sync_status",data:JSON.stringify({eventid:o,syncon:n?1:0})},done:function(e){let t=document.querySelector('tr[data-eventid="'+o+'"]');t.dataset.status=n?1:0}}])})})},t.prototype.getForNextRow=function(e){var t=this,e=e+1;t.eventrows.length>e&&t.getConflictsForRow(t.eventrows[e].dataset.eventid,e)},t.prototype.getConflictsForRow=function(t,o){var n=this;s.debug("Getting conflicts for row "+o+" eventid "+n.eventrows[o].dataset.eventid),n.eventrows[o].classList.remove("conflicts-checked"),n.eventrows[o].classList.remove("has-conflicts"),n.eventrows[o].classList.remove("has-ignored-conflicts"),n.eventrows[o].classList.remove("no-conflicts"),n.eventrows[o].dataset.conflicts="",n.eventrows[o].classList.add("checking-conflicts"),a.call([{methodname:"local_excursions_formcontrol",args:{action:"check_conflicts_for_event",data:t},done:function(e){let t=JSON.parse(e);n.eventrows[o].classList.remove("checking-conflicts"),n.eventrows[o].classList.add("conflicts-checked"),t.conflicts.length?(0<t.conflicts.filter(e=>1!=e.status).length?n.eventrows[o].classList.add("has-conflicts"):n.eventrows[o].classList.add("has-ignored-conflicts"),n.eventrows[o].dataset.conflicts=t.html):n.eventrows[o].classList.add("no-conflicts"),n.getForNextRow(o)},fail:function(e){n.eventrows[o].classList.remove("checking-conflicts"),n.eventrows[o].classList.add("conflicts-checked"),s.error("local_excursions/events: failed to check conflicts for event "+t),s.debug(e),n.getForNextRow(o)}}])},{init:function(){s.debug("local_excursions/events: initializing");var e=c("#page-local-excursions-events");e.length?new t(e).main():s.error("local_excursions/events: #page-local-excursions-events not found!")}}});