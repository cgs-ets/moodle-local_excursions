define(["jquery","core/log","core/ajax","core/modal_factory","core/modal_events"],function(t,c,s,o,n){"use strict";function a(e){var t=this;t.rootel=e,t.eventrows=document.querySelectorAll("table.events tr.event"),t.eventrows=Array.from(t.eventrows),t.conflictignorechange=!1,o.create({type:o.types.DEFAULT}).then(function(e){e.setTitle("Conflicts found"),t.modal=e,t.modal.getModal().addClass("modal-xl"),t.modal.getModal().addClass("modal-conflicts"),t.modal.getRoot().on(n.hidden,function(){t.conflictignorechange&&location.reload()})})}return a.prototype.main=function(){var o=this;o.eventrows.length&&o.getForNextRow(-1),document.querySelectorAll(".btn-showconflicts").forEach(t=>{t.addEventListener("click",e=>{e.preventDefault();e=t.dataset.eventid,e=document.querySelector('tr[data-eventid="'+e+'"]');e&&(o.modal.setBody('<div class="conflicts-wrap">'+e.dataset.conflicts+"</div>"),o.modal.show(),document.querySelectorAll('.modal-conflicts input[name="status"]').forEach(e=>{e.addEventListener("change",e=>{o.conflictignorechange=!0,s.call([{methodname:"local_excursions_formcontrol",args:{action:"set_conflict_status",data:JSON.stringify({conflictid:e.currentTarget.dataset.conflictid,status:e.currentTarget.checked})}}])})}))})})},a.prototype.getForNextRow=function(e){var t=this,e=e+1;t.eventrows.length>e&&t.getConflictsForRow(t.eventrows[e].dataset.eventid,e)},a.prototype.getConflictsForRow=function(t,o){var n=this;c.debug("Getting conflicts for row "+o+" eventid "+n.eventrows[o].dataset.eventid),n.eventrows[o].classList.remove("conflicts-checked"),n.eventrows[o].classList.remove("has-conflicts"),n.eventrows[o].classList.remove("has-ignored-conflicts"),n.eventrows[o].classList.remove("no-conflicts"),n.eventrows[o].dataset.conflicts="",n.eventrows[o].classList.add("checking-conflicts"),s.call([{methodname:"local_excursions_formcontrol",args:{action:"check_conflicts_for_event",data:t},done:function(e){let t=JSON.parse(e);n.eventrows[o].classList.remove("checking-conflicts"),n.eventrows[o].classList.add("conflicts-checked"),t.conflicts.length?(0<t.conflicts.filter(e=>1!=e.status).length?n.eventrows[o].classList.add("has-conflicts"):n.eventrows[o].classList.add("has-ignored-conflicts"),n.eventrows[o].dataset.conflicts=t.html):n.eventrows[o].classList.add("no-conflicts"),n.getForNextRow(o)},fail:function(e){n.eventrows[o].classList.remove("checking-conflicts"),n.eventrows[o].classList.add("conflicts-checked"),c.error("local_excursions/events: failed to check conflicts for event "+t),c.debug(e),n.getForNextRow(o)}}])},{init:function(){c.debug("local_excursions/events: initializing");var e=t("#page-local-excursions-events");e.length?new a(e).main():c.error("local_excursions/events: #page-local-excursions-events not found!")}}});