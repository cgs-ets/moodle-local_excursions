define(["jquery","local_excursions/recipientselector","core/log","core/templates","core/ajax","core/str","core/modal_factory","core/modal_events"],function(r,o,d,i,c,t,a,n){"use strict";function e(t){var e=this;e.rootel=t,e.form=e.rootel.find('form[data-form="excursions-activity"]'),e.addstudentsinit=!1,e.studentlistwrap=e.rootel.find(".student-list-wrap"),e.studentlist=new Array}return e.prototype.main=function(){var n=this,t=(n.renderStudentsFromJSON(),n.staffincharge=o.init("staffincharge","staff",0),n.planningstaff=o.init("planningstaff","staff",1),n.accompanyingstaff=o.init("accompanyingstaff","staff",1),n.rootel.on("blur",'input[name="activityname"]',function(t){r(this).val().length&&n.autoSave()}),n.rootel.on("change",'input[name="campus"]',function(t){var e=n.rootel.find('input[name="campus"]:checked').val();e&&(n.rootel.removeClass(function(t,e){return(e.match(/(^|\s)activitycampus-\S+/g)||[]).join(" ")}),n.rootel.addClass("activitycampus-"+e))}),n.rootel.on("change",'input[name="activitytype"]',function(t){var e=n.rootel.find('input[name="activitytype"]:checked').val();e&&(n.rootel.removeClass(function(t,e){return(e.match(/(^|\s)activitytype-\S+/g)||[]).join(" ")}),n.rootel.addClass("activitytype-"+e))}),n.rootel.find('input[name="campus"]').change(),n.rootel.find('input[name="activitytype"]').change(),n.rootel.on("click","#enablepermissionshelplink",function(t){t.preventDefault(),n.permissionHelpModal()}),n.rootel.on("click","#btn-addstudents",function(t){t.preventDefault(),n.addStudents()}),n.rootel.on("change",'input[name="addstudentby"]',function(t){var e=r(this);e.closest(".student-selector").attr("class","student-selector").addClass(e.val())}),n.rootel.on("change","input.userselect",function(t){n.checkSelected()}),n.rootel.on("click","#btn-deletestudents",function(t){t.preventDefault(),n.deleteStudents()}),n.rootel.on("click",'input[name="savedraft"]',function(t){n.form.find('[name="action"]').val("savedraft")}),n.rootel.on("click",'input[name="cancel"]',function(t){n.form.find('[name="action"]').val("cancel")}),n.rootel.on("click",'input[name="delete"]',function(t){n.form.find('[name="action"]').val("delete")}),n.rootel.on("click",'input[name="sendforreview"]',function(t){n.form.find('[name="action"]').val("sendforreview")}),n.rootel.on("click","#btn-postcomment",function(t){t.preventDefault();t=r(this);n.postComment(t)}),n.rootel.on("click",".delete-comment",function(t){t.preventDefault();t=r(this);n.deleteComment(t)}),n.rootel.on("change","input.approve",function(t){var e=r(this);n.submitApproval(e)}),n.rootel.on("click",'.approval .action-skip[data-skip="0"]',function(t){t.preventDefault();t=r(this);n.skipApproval(t,1)}),n.rootel.on("click",'.approval .action-skip[data-skip="1"]',function(t){t.preventDefault();t=r(this);n.skipApproval(t,0)}),n.rootel.on("click",".approval .nominate-approver-btn",function(t){t.preventDefault();t=r(this);n.nominateApprover(t)}),n.rootel.on("change",".approval .nominate-approver-select",function(t){r(this).closest(".approval").removeClass("nominated")}),n.rootel.on("click",".notice .action-delete-absences",function(t){var e=r(this);n.deletePreviousAbsences(e)}),n.rootel.on("change",'input[name="enable-permissions"]',function(t){var e=r(this);n.enablePermissions(e)}),n.rootel.on("click","#btn-preparemessage",function(t){t.preventDefault(),n.rootel.find(".prepare-message").addClass("active"),n.rootel.find("#btn-preparemessage").addClass("opened")}),n.rootel.on("click","#btn-sendpermissions",function(t){t.preventDefault();t=r(this);n.sendPermissions(t)}),n.rootel.on("click","#btn-checkall",function(t){t.preventDefault(),n.checkAllStudents()}),n.rootel.on("click","#btn-uncheckall",function(t){t.preventDefault(),n.uncheckAllStudents()}),n.rootel.on("change",'input[name="invitetype"]',function(t){var e=r(this);n.rootel.find(".invitetype-message").hide(),n.rootel.find('.invitetype-message[data-type="'+e.val()+'"').show(),n.studentlistwrap.removeClass(function(t,e){return(e.match(/(^|\s)invitetype-\S+/g)||[]).join(" ")}),n.studentlistwrap.addClass("invitetype-"+e.val()),n.form.find('input[name="hiddeninvitetype"]').val(e.val())}),n.rootel.on("blur",'input[name="limit"]',function(t){n.form.find('input[name="hiddenlimit"]').val(r(this).val())}),n.rootel.on("blur",'input[name="limit"]',function(t){n.form.find('input[name="hiddenlimit"]').val(r(this).val())}),n.rootel.on("blur","select[name^='timedueby']",function(t){var e=n.rootel.find("select[name^='timedueby']").map(function(){return r(this).val()}).get();n.form.find('input[name="hiddendueby"]').val(JSON.stringify(e))}),n.rootel.on("click",".btn-showextratext",function(t){t.preventDefault();t=r(this);n.previewEmail(t)}),n.modals={ADDSTUDENTS:null,PREVIEWEMAIL:null,PERMISSIONSHELP:null},n.templates={ADDSTUDENTS:"local_excursions/activityform_studentselector",PREVIEWEMAIL:"local_excursions/preview_permissions_email"},[]);t.push(n.loadModal("ADDSTUDENTS","","Add",a.types.SAVE_CANCEL)),t.push(n.loadModal("PREVIEWEMAIL","Email template","",a.types.DEFAULT)),t.push(n.loadModal("PERMISSIONSHELP","Do I need parent permission?","",a.types.DEFAULT)),t.push(n.loadTemplate("ADDSTUDENTS")),t.push(n.loadTemplate("PREVIEWEMAIL")),r.when.apply(r,t).then(function(){n.rootel.removeClass("preloading").addClass("preloads-completed"),n.loadComments()})},e.prototype.renderStudentsFromJSON=function(){var t=this,e=t.form.find('input[name="studentlistjson"]').first().val(),n=[];e&&(n=JSON.parse(e)),t.studentlist=new Array;for(var o=0;o<n.length;o++)t.studentlist.push(n[o]);t.studentlist.length&&(t.studentlistwrap.addClass("loading"),t.regenerateStudentList())},e.prototype.addStudents=function(){var e=this;e.modals.ADDSTUDENTS&&(e.addstudentsinit||(c.call([{methodname:"local_excursions_formcontrol",args:{action:"get_student_selector_data",data:""},done:function(t){t=JSON.parse(t);i.render(e.templates.ADDSTUDENTS,{courses:t.courses,groups:t.groups,taglists:t.taglists}).done(function(t){e.modals.ADDSTUDENTS.setBody(t),e.studentselector=o.init("studentselector","student",1),e.addstudentsinit=!0}).fail(function(t){return d.debug(t),"Failed to render student selector."})},fail:function(t){return d.debug(t),"Failed to load student selector data."}}]),e.modals.ADDSTUDENTS.getModal().addClass("modal-xl"),e.modals.ADDSTUDENTS.getRoot().on(n.save,{self:e},e.handleAddStudents)),e.modals.ADDSTUDENTS.show())},e.prototype.handleAddStudents=function(t){var e,o=t.data.self,t=(o.studentlistwrap.addClass("loading"),o.rootel.find('input[name="addstudentby"]:checked').val());if("individual"==t){var n=o.rootel.find('input[name="studentselectorjson"]');if(n.val()){var i=JSON.parse(n.val());if(i.length){o.studentlistwrap.addClass("changes-not-saved");for(var a=0;a<i.length;a++)o.studentlist.push(i[a].idfield.toString());o.regenerateStudentList()}return n.val(""),void o.studentselector.render()}}return"course"==t?(e=o.rootel.find('select[name="course"]'),void c.call([{methodname:"local_excursions_formcontrol",args:{action:"get_student_usernames_from_courseid",data:e.val()},done:function(t){var e=JSON.parse(t);if(e.length){for(var t=JSON.stringify(o.studentlist.filter(o.onlyUnique)),n=0;n<e.length;n++)o.studentlist.push(e[n].toString());t!=JSON.stringify(o.studentlist.filter(o.onlyUnique))&&o.studentlistwrap.addClass("changes-not-saved")}o.regenerateStudentList()},fail:function(t){d.debug(t)}}])):"group"==t?(e=o.rootel.find('select[name="group"]'),void c.call([{methodname:"local_excursions_formcontrol",args:{action:"get_student_usernames_from_groupid",data:e.val()},done:function(t){var e=JSON.parse(t);if(e.length){for(var t=JSON.stringify(o.studentlist.filter(o.onlyUnique)),n=0;n<e.length;n++)o.studentlist.push(e[n].toString());t!=JSON.stringify(o.studentlist.filter(o.onlyUnique))&&o.studentlistwrap.addClass("changes-not-saved")}o.regenerateStudentList()},fail:function(t){d.debug(t)}}])):"taglist"==t?(n=o.rootel.find('select[name="usertaglists"]'),e=o.rootel.find('select[name="publictaglists"]'),c.call([{methodname:"local_excursions_formcontrol",args:{action:"get_student_usernames_from_taglists",data:JSON.stringify({user:n.val(),public:e.val()})},done:function(t){var e=JSON.parse(t);if(e.length){for(var t=JSON.stringify(o.studentlist.filter(o.onlyUnique)),n=0;n<e.length;n++)o.studentlist.push(e[n].toString());t!=JSON.stringify(o.studentlist.filter(o.onlyUnique))&&o.studentlistwrap.addClass("changes-not-saved")}o.regenerateStudentList()},fail:function(t){d.debug(t)}}]),n.val(""),void e.val("")):void o.studentlistwrap.removeClass("loading")},e.prototype.regenerateStudentList=function(){var i=this,a=i.rootel.find(".student-list tbody"),t=i.form.find('input[name="edit"]').val();i.studentlist=i.studentlist.filter(i.onlyUnique),i.form.find('input[name="studentlistjson"]').val(JSON.stringify(i.studentlist)),c.call([{methodname:"local_excursions_formcontrol",args:{action:"regenerate_student_list",data:JSON.stringify({activityid:t,users:i.studentlist})},done:function(t){a.html(t);var t=i.form.find(".medical-report"),t=(0===i.studentlist.length?(i.studentlistwrap.removeClass("has-students"),t.removeClass("has-students")):(i.studentlistwrap.addClass("has-students"),t.addClass("has-students")),i.studentlistwrap.removeClass("loading"),i.studentlistwrap.find("tr.student").length),t=(i.studentlistwrap.find(".count-students").html(t),i.rootel.hasClass("activity-status-3")),e=!i.studentlistwrap.hasClass("has-message-history"),n=i.studentlistwrap.hasClass("permissions-enabled"),o=i.studentlistwrap.hasClass("invitetype-system");t&&e&&n&&o&&(i.checkAllStudents(),i.rootel.find("#btn-preparemessage").click()),i.checkSelected()},fail:function(t){d.debug(t),i.studentlistwrap.removeClass("loading")}}])},e.prototype.deleteStudents=function(){var n=this;n.studentlistwrap.addClass("loading"),n.rootel.find("input.userselect:checked").each(function(t){var e=r(this).val();-1!==(t=n.studentlist.indexOf(e.toString()))&&n.studentlist.splice(t,1)}),n.studentlistwrap.addClass("changes-not-saved"),n.regenerateStudentList()},e.prototype.checkSelected=function(){this.rootel.find("input.userselect:checked").length?this.studentlistwrap.addClass("has-selected"):this.studentlistwrap.removeClass("has-selected")},e.prototype.autoSave=function(){var t=this.getFormJSON();c.call([{methodname:"local_excursions_formcontrol",args:{action:"autosave",data:t},done:function(){},fail:function(t){d.debug(t)}}])},e.prototype.getFormJSON=function(){var t=this.form.find('input[name="edit"]').val(),e=this.form.find('input[name="activityname"]').val();return JSON.stringify({id:t,activityname:e})},e.prototype.loadModal=function(e,n,o,t){var i=this;return a.create({type:t}).then(function(t){t.setTitle(n),o&&t.setSaveButtonText(o),(i.modals[e]=t).getBackdrop(),t.getRoot().addClass("modal-"+e)})},e.prototype.loadTemplate=function(t){return i.render(this.templates[t],{})},e.prototype.onlyUnique=function(t,e,n){return n.indexOf(t)===e},e.prototype.postComment=function(t){var e=this,n=e.form.find('input[name="edit"]').val(),o=e.rootel.find(".reply-form"),i=o.find(".reply-comment"),a=e.rootel.find(".comments");0!=i.val().trim().length&&(o.addClass("submitting"),a.addClass("loading"),c.call([{methodname:"local_excursions_formcontrol",args:{action:"post_comment",data:JSON.stringify({activityid:n,comment:i.val()})},done:function(t){o.removeClass("submitting"),i.val(""),e.loadComments()},fail:function(t){o.removeClass("submitting"),d.error("local_excursions/activityform: failed to post comment."),d.debug(t)}}]))},e.prototype.deleteComment=function(t){var e=this,t=t.data("id");e.rootel.find(".comments").addClass("loading"),c.call([{methodname:"local_excursions_formcontrol",args:{action:"delete_comment",data:t},done:function(t){e.loadComments()},fail:function(t){d.error("local_excursions/activityform: failed to delete comment."),d.debug(t)}}])},e.prototype.loadComments=function(t){var e=this.form.find('input[name="edit"]').val(),n=this.rootel.find(".comments");n.addClass("loading"),c.call([{methodname:"local_excursions_formcontrol",args:{action:"get_comments",data:e},done:function(t){n.removeClass("loading"),n.html(t)},fail:function(t){n.removeClass("loading"),d.error("local_excursions/activityform: failed to load comments."),d.debug(t)}}])},e.prototype.submitApproval=function(t){var e=this,n=0,o=(t.is(":checked")&&(n=1),e.form.find('input[name="edit"]').val()),i=t.data("id"),a=t.closest(".approval");a.addClass("submitting"),c.call([{methodname:"local_excursions_formcontrol",args:{action:"save_approval",data:JSON.stringify({activityid:o,approvalid:i,checked:n})},done:function(t){t=JSON.parse(t);a.removeClass("submitting"),a.attr("data-status",n),e.rootel.find(".status").replaceWith(t.statushtml),e.rootel.find(".workflow").replaceWith(t.workflowhtml),e.rootel.removeClass(function(t,e){return(e.match(/(^|\s)activity-status-\S+/g)||[]).join(" ")}),e.rootel.addClass("activity-status-"+t.status)},fail:function(t){a.removeClass("submitting"),d.error("local_excursions/activityform: failed to submit approval."),d.debug(t)}}])},e.prototype.skipApproval=function(e,n){var o=this,t=o.form.find('input[name="edit"]').val(),i=e.closest(".approval"),a=i.data("id");i.addClass("submitting"),c.call([{methodname:"local_excursions_formcontrol",args:{action:"skip_approval",data:JSON.stringify({activityid:t,approvalid:a,skip:n})},done:function(t){t=JSON.parse(t);i.removeClass("submitting"),i.attr("data-skip",n),e.attr("data-skip",n),o.rootel.find(".status").replaceWith(t.statushtml),o.rootel.find(".workflow").replaceWith(t.workflowhtml),o.rootel.removeClass(function(t,e){return(e.match(/(^|\s)activity-status-\S+/g)||[]).join(" ")}),o.rootel.addClass("activity-status-"+t.status)},fail:function(t){i.removeClass("submitting"),d.error("local_excursions/activityform: failed to submit approval skip."),d.debug(t)}}])},e.prototype.nominateApprover=function(e){var t=this.form.find('input[name="edit"]').val(),n=e.closest(".approval"),o=n.data("id"),i=n.find(".nominate-approver-select").val();""!=i&&(n.addClass("submitting"),c.call([{methodname:"local_excursions_formcontrol",args:{action:"nominate_approver",data:JSON.stringify({activityid:t,approvalid:o,nominated:i})},done:function(t){t=JSON.parse(t);n.removeClass("submitting"),"complete"==t.status&&e.replaceWith("<span>Notified...</span>")},fail:function(t){n.removeClass("submitting"),d.error("local_excursions/activityform: failed to submit nominated approver."),d.debug(t)}}]))},e.prototype.deletePreviousAbsences=function(t){var e=this.form.find('input[name="edit"]').val(),n=t.closest(".notice");n.addClass("submitting"),c.call([{methodname:"local_excursions_formcontrol",args:{action:"delete_previous_activities",data:e},done:function(t){n.html("<td>"+t+"</td>"),n.removeClass("submitting"),n.addClass("completed")},fail:function(t){n.removeClass("submitting"),d.error("local_excursions/activityform: failed to delete previous absences."),d.debug(t)}}])},e.prototype.enablePermissions=function(t){var e=0,t=(t.is(":checked")?(e=1,this.studentlistwrap.addClass("permissions-enabled")):this.studentlistwrap.removeClass("permissions-enabled"),this.form.find('input[name="edit"]').val());c.call([{methodname:"local_excursions_formcontrol",args:{action:"enable_permissions",data:JSON.stringify({activityid:t,checked:e})},done:function(t){},fail:function(t){d.error("local_excursions/activityform: failed to enable permissions."),d.debug(t)}}])},e.prototype.sendPermissions=function(t){var e,n,o,i,a,s=this,l=new Array;s.rootel.find("input.userselect:checked").each(function(t){l.push(r(this).val().toString())});l.length&&(i=s.rootel.find("#permissions-extra-text"),e=s.form.find('input[name="edit"]').val(),n=s.form.find('input[name="limit"]'),o=s.rootel.find("select[name^='timedueby']").map(function(){return r(this).val()}).get(),i=s.rootel.find("#permissions-extra-text"),(a=s.rootel.find(".prepare-message")).addClass("submitting"),c.call([{methodname:"local_excursions_formcontrol",args:{action:"send_permissions",data:JSON.stringify({activityid:e,limit:n.val(),dueby:JSON.stringify(o),users:JSON.stringify(l),extratext:i.val()})},done:function(t){a.removeClass("submitting").addClass("sent"),s.reloadMessageHistory(),setTimeout(function(){s.rootel.find("#btn-preparemessage").removeClass("opened"),a.removeClass("active").removeClass("sent"),s.uncheckAllStudents()},5e3)},fail:function(t){d.error("local_excursions/activityform: failed to send permission emails."),d.debug(t)}}]))},e.prototype.uncheckAllStudents=function(){this.rootel.find("input.userselect").each(function(){this.checked=!1}),this.checkSelected()},e.prototype.checkAllStudents=function(){this.rootel.find("input.userselect").each(function(){this.checked=!0}),this.checkSelected()},e.prototype.reloadMessageHistory=function(){var e=this,n=e.rootel.find(".message-history"),t=e.form.find('input[name="edit"]').val();c.call([{methodname:"local_excursions_formcontrol",args:{action:"get_message_history",data:t},done:function(t){n.html(t),e.studentlistwrap.addClass("has-message-history")},fail:function(t){d.debug(t)}}])},e.prototype.previewEmail=function(t){var e=this,t=t.closest(".emailaction"),n=t.find(".c-students").html(),t=t.find(".c-extratext").html();e.modals.PREVIEWEMAIL&&(i.render(e.templates.PREVIEWEMAIL,{info:'<div style="margin-bottom: 15px;">To the parents of: '+n+"</div>",emailsubject:"Subject: Permissions required for: {activity name}",extratext:t,parentname:"{parent name will be added automatically}",studentname:"{student name will be added automatically}",activitydetails:"{Activity details}",buttonoverride:"{A button prompting the parent to respond appears here}"}).done(function(t){e.modals.PREVIEWEMAIL.setBody(t)}).fail(function(t){return d.debug(t),"Failed to load email preview."}),e.modals.PREVIEWEMAIL.getModal().addClass("modal-xl"),e.modals.PREVIEWEMAIL.show())},e.prototype.permissionHelpModal=function(){var t=this,e=t.rootel.find("#enablepermissionshelpbody").html();t.modals.PERMISSIONSHELP&&(t.modals.PERMISSIONSHELP.setBody(e),t.modals.PERMISSIONSHELP.getModal().addClass("modal-xl"),t.modals.PERMISSIONSHELP.show())},{init:function(){d.debug("local_excursions/activity: initializing");var t=r("#page-local-excursions-activity");t.length?new e(t).main():d.error("local_excursions/activities: #page-local-excursions-activity not found!")}}});