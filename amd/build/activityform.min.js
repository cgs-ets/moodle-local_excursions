define(["jquery","local_excursions/recipientselector","core/log","core/templates","core/ajax","core/str","core/modal_factory","core/modal_events"],function(r,o,d,s,u,t,i,n){"use strict";function e(t){var e=this;e.rootel=t,e.form=e.rootel.find('form[data-form="excursions-activity"]'),e.addstudentsinit=!1,e.studentlistwrap=e.rootel.find(".student-list-wrap"),e.studentlist=new Array}return e.prototype.main=function(){var n=this;n.renderStudentsFromJSON(),n.staffincharge=o.init("staffincharge","staff",0),n.accompanyingstaff=o.init("accompanyingstaff","staff",1),n.rootel.on("blur",'input[name="activityname"]',function(t){r(this).val().length&&n.autoSave()}),n.rootel.on("click","#btn-addstudents",function(t){t.preventDefault(),n.addStudents()}),n.rootel.on("change",'input[name="addstudentby"]',function(t){var e=r(this);e.closest(".student-selector").attr("class","student-selector").addClass(e.val())}),n.rootel.on("change","input.userselect",function(t){n.checkSelected()}),n.rootel.on("click","#btn-deletestudents",function(t){t.preventDefault(),n.deleteStudents()}),n.rootel.on("click","#btn-savedraft",function(t){t.preventDefault(),window.onbeforeunload=null,n.form.find('[name="action"]').val("savedraft"),n.form.submit()}),n.rootel.on("click","#btn-cancel",function(t){t.preventDefault(),window.onbeforeunload=null,n.form.find('[name="action"]').val("cancel"),n.form.submit()}),n.rootel.on("click","#btn-delete",function(t){t.preventDefault(),window.onbeforeunload=null,n.form.find('[name="action"]').val("delete"),n.form.submit()}),n.rootel.on("click","#btn-sendforreview",function(t){t.preventDefault(),window.onbeforeunload=null,n.form.find('[name="action"]').val("sendforreview"),n.form.submit()}),n.rootel.on("click","#btn-postcomment",function(t){t.preventDefault();t=r(this);n.postComment(t)}),n.rootel.on("click",".delete-comment",function(t){t.preventDefault();t=r(this);n.deleteComment(t)}),n.rootel.on("change","input.approve",function(t){var e=r(this);n.submitApproval(e)}),n.rootel.on("change",'input[name="enable-permissions"]',function(t){var e=r(this);n.enablePermissions(e)}),n.rootel.on("click","#btn-preparemessage",function(t){t.preventDefault(),n.rootel.find(".prepare-message").addClass("active"),n.rootel.find("#btn-preparemessage").addClass("opened")}),n.rootel.on("click","#btn-sendpermissions",function(t){t.preventDefault();t=r(this);n.sendPermissions(t)}),n.rootel.on("click","#btn-checkall",function(t){t.preventDefault(),n.checkAllStudents()}),n.rootel.on("click","#btn-uncheckall",function(t){t.preventDefault(),n.uncheckAllStudents()}),n.rootel.on("change",'input[name="invitetype"]',function(t){var e=r(this);n.rootel.find(".invitetype-message").hide(),n.rootel.find('.invitetype-message[data-type="'+e.val()+'"').show(),n.studentlistwrap.removeClass(function(t,e){return(e.match(/(^|\s)invitetype-\S+/g)||[]).join(" ")}),n.studentlistwrap.addClass("invitetype-"+e.val()),n.form.find('input[name="hiddeninvitetype"]').val(e.val())}),n.rootel.on("blur",'input[name="limit"]',function(t){n.form.find('input[name="hiddenlimit"]').val(r(this).val())}),n.rootel.on("blur",'input[name="limit"]',function(t){n.form.find('input[name="hiddenlimit"]').val(r(this).val())}),n.rootel.on("blur","select[name^='timedueby']",function(t){var e=n.rootel.find("select[name^='timedueby']").map(function(){return r(this).val()}).get();n.form.find('input[name="hiddendueby"]').val(JSON.stringify(e))}),n.rootel.on("click",".btn-showextratext",function(t){t.preventDefault();t=r(this);n.previewEmail(t)}),n.modals={ADDSTUDENTS:null,PREVIEWEMAIL:null},n.templates={ADDSTUDENTS:"local_excursions/activityform_studentselector",PREVIEWEMAIL:"local_excursions/preview_permissions_email"};var t=[];t.push(n.loadModal("ADDSTUDENTS","","Add",i.types.SAVE_CANCEL)),t.push(n.loadModal("PREVIEWEMAIL","Email template","",i.types.DEFAULT)),t.push(n.loadTemplate("ADDSTUDENTS")),t.push(n.loadTemplate("PREVIEWEMAIL")),r.when.apply(r,t).then(function(){n.rootel.removeClass("preloading").addClass("preloads-completed"),n.loadComments()})},e.prototype.renderStudentsFromJSON=function(){var t=this,e=t.form.find('input[name="studentlistjson"]').first().val(),n=[];e&&(n=JSON.parse(e)),t.studentlist=new Array;for(var o=0;o<n.length;o++)t.studentlist.push(n[o]);t.studentlist.length&&(t.studentlistwrap.addClass("loading"),t.regenerateStudentList())},e.prototype.addStudents=function(){var e=this;e.modals.ADDSTUDENTS&&(e.addstudentsinit||(u.call([{methodname:"local_excursions_formcontrol",args:{action:"get_student_selector_data",data:""},done:function(t){t=JSON.parse(t);s.render(e.templates.ADDSTUDENTS,{courses:t.courses,groups:t.groups,taglists:t.taglists}).done(function(t){e.modals.ADDSTUDENTS.setBody(t),e.studentselector=o.init("studentselector","student",1),e.addstudentsinit=!0}).fail(function(t){return d.debug(t),"Failed to render student selector."})},fail:function(t){return d.debug(t),"Failed to load student selector data."}}]),e.modals.ADDSTUDENTS.getModal().addClass("modal-xl"),e.modals.ADDSTUDENTS.getRoot().on(n.save,{self:e},e.handleAddStudents)),e.modals.ADDSTUDENTS.show())},e.prototype.handleAddStudents=function(t){var o=t.data.self;o.studentlistwrap.addClass("loading");t=o.rootel.find('input[name="addstudentby"]:checked').val();if("individual"==t){var e=o.rootel.find('input[name="studentselectorjson"]');if(e.val()){var n=JSON.parse(e.val());if(n.length){o.studentlistwrap.addClass("changes-not-saved");for(var s=0;s<n.length;s++)o.studentlist.push(n[s].idfield.toString());o.regenerateStudentList()}return e.val(""),void o.studentselector.render()}}if("course"!=t)if("group"!=t){if("taglist"==t){e=o.rootel.find('select[name="usertaglists"]'),t=o.rootel.find('select[name="publictaglists"]');return u.call([{methodname:"local_excursions_formcontrol",args:{action:"get_student_usernames_from_taglists",data:JSON.stringify({user:e.val(),public:t.val()})},done:function(t){var e=JSON.parse(t);if(e.length){for(var t=JSON.stringify(o.studentlist.filter(o.onlyUnique)),n=0;n<e.length;n++)o.studentlist.push(e[n].toString());t!=JSON.stringify(o.studentlist.filter(o.onlyUnique))&&o.studentlistwrap.addClass("changes-not-saved")}o.regenerateStudentList()},fail:function(t){d.debug(t)}}]),e.val(""),void t.val("")}o.studentlistwrap.removeClass("loading")}else{i=o.rootel.find('select[name="group"]');u.call([{methodname:"local_excursions_formcontrol",args:{action:"get_student_usernames_from_groupid",data:i.val()},done:function(t){var e=JSON.parse(t);if(e.length){for(var t=JSON.stringify(o.studentlist.filter(o.onlyUnique)),n=0;n<e.length;n++)o.studentlist.push(e[n].toString());t!=JSON.stringify(o.studentlist.filter(o.onlyUnique))&&o.studentlistwrap.addClass("changes-not-saved")}o.regenerateStudentList()},fail:function(t){d.debug(t)}}])}else{var i=o.rootel.find('select[name="course"]');u.call([{methodname:"local_excursions_formcontrol",args:{action:"get_student_usernames_from_courseid",data:i.val()},done:function(t){var e=JSON.parse(t);if(e.length){for(var t=JSON.stringify(o.studentlist.filter(o.onlyUnique)),n=0;n<e.length;n++)o.studentlist.push(e[n].toString());t!=JSON.stringify(o.studentlist.filter(o.onlyUnique))&&o.studentlistwrap.addClass("changes-not-saved")}o.regenerateStudentList()},fail:function(t){d.debug(t)}}])}},e.prototype.regenerateStudentList=function(){var s=this,i=s.rootel.find(".student-list tbody"),t=s.form.find('input[name="edit"]').val();s.studentlist=s.studentlist.filter(s.onlyUnique),s.form.find('input[name="studentlistjson"]').val(JSON.stringify(s.studentlist)),u.call([{methodname:"local_excursions_formcontrol",args:{action:"regenerate_student_list",data:JSON.stringify({activityid:t,users:s.studentlist})},done:function(t){i.html(t);var e=s.form.find(".medical-report");0===s.studentlist.length?(s.studentlistwrap.removeClass("has-students"),e.removeClass("has-students")):(s.studentlistwrap.addClass("has-students"),e.addClass("has-students")),s.studentlistwrap.removeClass("loading");var n=s.studentlistwrap.find("tr.student").length;s.studentlistwrap.find(".count-students").html(n);var o=s.rootel.hasClass("activity-status-3"),t=!s.studentlistwrap.hasClass("has-message-history"),e=s.studentlistwrap.hasClass("permissions-enabled"),n=s.studentlistwrap.hasClass("invitetype-system");o&&t&&e&&n&&(s.checkAllStudents(),s.rootel.find("#btn-preparemessage").click()),s.checkSelected()},fail:function(t){d.debug(t),s.studentlistwrap.removeClass("loading")}}])},e.prototype.deleteStudents=function(){var n=this;n.studentlistwrap.addClass("loading"),n.rootel.find("input.userselect:checked").each(function(t){var e=r(this).val();-1!==(t=n.studentlist.indexOf(e.toString()))&&n.studentlist.splice(t,1)}),n.studentlistwrap.addClass("changes-not-saved"),n.regenerateStudentList()},e.prototype.checkSelected=function(){this.rootel.find("input.userselect:checked").length?this.studentlistwrap.addClass("has-selected"):this.studentlistwrap.removeClass("has-selected")},e.prototype.autoSave=function(){var t=this.getFormJSON();u.call([{methodname:"local_excursions_formcontrol",args:{action:"autosave",data:t},done:function(){},fail:function(t){d.debug(t)}}])},e.prototype.getFormJSON=function(){var t={id:this.form.find('input[name="edit"]').val(),activityname:this.form.find('input[name="activityname"]').val()};return JSON.stringify(t)},e.prototype.loadModal=function(e,n,o,t){var s=this;return i.create({type:t}).then(function(t){t.setTitle(n),o&&t.setSaveButtonText(o),(s.modals[e]=t).getBackdrop(),t.getRoot().addClass("modal-"+e)})},e.prototype.loadTemplate=function(t){return s.render(this.templates[t],{})},e.prototype.onlyUnique=function(t,e,n){return n.indexOf(t)===e},e.prototype.postComment=function(t){var e=this,n=e.form.find('input[name="edit"]').val(),o=e.rootel.find(".reply-form"),s=o.find(".reply-comment"),i=e.rootel.find(".comments");0!=s.val().trim().length&&(o.addClass("submitting"),i.addClass("loading"),u.call([{methodname:"local_excursions_formcontrol",args:{action:"post_comment",data:JSON.stringify({activityid:n,comment:s.val()})},done:function(t){o.removeClass("submitting"),s.val(""),e.loadComments()},fail:function(t){o.removeClass("submitting"),d.error("local_excursions/activityform: failed to post comment."),d.debug(t)}}]))},e.prototype.deleteComment=function(t){var e=this,t=t.data("id");e.rootel.find(".comments").addClass("loading"),u.call([{methodname:"local_excursions_formcontrol",args:{action:"delete_comment",data:t},done:function(t){e.loadComments()},fail:function(t){d.error("local_excursions/activityform: failed to delete comment."),d.debug(t)}}])},e.prototype.loadComments=function(t){var e=this.form.find('input[name="edit"]').val(),n=this.rootel.find(".comments");n.addClass("loading"),u.call([{methodname:"local_excursions_formcontrol",args:{action:"get_comments",data:e},done:function(t){n.removeClass("loading"),n.html(t)},fail:function(t){n.removeClass("loading"),d.error("local_excursions/activityform: failed to load comments."),d.debug(t)}}])},e.prototype.submitApproval=function(t){var e=this,n=0;t.is(":checked")&&(n=1);var o=e.form.find('input[name="edit"]').val(),s=t.data("id"),i=t.closest(".approval");i.addClass("submitting"),u.call([{methodname:"local_excursions_formcontrol",args:{action:"save_approval",data:JSON.stringify({activityid:o,approvalid:s,checked:n})},done:function(t){t=JSON.parse(t);i.removeClass("submitting"),i.attr("data-status",n),e.rootel.find(".status").replaceWith(t.html),e.rootel.removeClass(function(t,e){return(e.match(/(^|\s)activity-status-\S+/g)||[]).join(" ")}),e.rootel.addClass("activity-status-"+t.status)},fail:function(t){i.removeClass("submitting"),d.error("local_excursions/activityform: failed to submit approval."),d.debug(t)}}])},e.prototype.enablePermissions=function(t){var e=0;t.is(":checked")?(e=1,this.studentlistwrap.addClass("permissions-enabled")):this.studentlistwrap.removeClass("permissions-enabled");t=this.form.find('input[name="edit"]').val();u.call([{methodname:"local_excursions_formcontrol",args:{action:"enable_permissions",data:JSON.stringify({activityid:t,checked:e})},done:function(t){},fail:function(t){d.error("local_excursions/activityform: failed to enable permissions."),d.debug(t)}}])},e.prototype.sendPermissions=function(t){var e,n,o,s,i,a=this,l=new Array;a.rootel.find("input.userselect:checked").each(function(t){l.push(r(this).val().toString())});l.length&&(s=a.rootel.find("#permissions-extra-text"),e=a.form.find('input[name="edit"]').val(),n=a.form.find('input[name="limit"]'),o=a.rootel.find("select[name^='timedueby']").map(function(){return r(this).val()}).get(),s=a.rootel.find("#permissions-extra-text"),(i=a.rootel.find(".prepare-message")).addClass("submitting"),u.call([{methodname:"local_excursions_formcontrol",args:{action:"send_permissions",data:JSON.stringify({activityid:e,limit:n.val(),dueby:JSON.stringify(o),users:JSON.stringify(l),extratext:s.val()})},done:function(t){i.removeClass("submitting").addClass("sent"),a.reloadMessageHistory(),setTimeout(function(){a.rootel.find("#btn-preparemessage").removeClass("opened"),i.removeClass("active").removeClass("sent"),a.uncheckAllStudents()},5e3)},fail:function(t){d.error("local_excursions/activityform: failed to send permission emails."),d.debug(t)}}]))},e.prototype.uncheckAllStudents=function(){this.rootel.find("input.userselect").each(function(){this.checked=!1}),this.checkSelected()},e.prototype.checkAllStudents=function(){this.rootel.find("input.userselect").each(function(){this.checked=!0}),this.checkSelected()},e.prototype.reloadMessageHistory=function(){var e=this,n=e.rootel.find(".message-history"),t=e.form.find('input[name="edit"]').val();u.call([{methodname:"local_excursions_formcontrol",args:{action:"get_message_history",data:t},done:function(t){n.html(t),e.studentlistwrap.addClass("has-message-history")},fail:function(t){d.debug(t)}}])},e.prototype.previewEmail=function(t){var e=this,n=t.closest(".emailaction"),t=n.find(".c-students").html(),n=n.find(".c-extratext").html();e.modals.PREVIEWEMAIL&&(s.render(e.templates.PREVIEWEMAIL,{info:'<div style="margin-bottom: 15px;">To the parents of: '+t+"</div>",emailsubject:"Subject: Permissions required for: {activity name}",extratext:n,parentname:"{parent name will be added automatically}",studentname:"{student name will be added automatically}",activitydetails:"{Activity details}",buttonoverride:"{A button prompting the parent to respond appears here}"}).done(function(t){e.modals.PREVIEWEMAIL.setBody(t)}).fail(function(t){return d.debug(t),"Failed to load email preview."}),e.modals.PREVIEWEMAIL.getModal().addClass("modal-xl"),e.modals.PREVIEWEMAIL.show())},{init:function(){d.debug("local_excursions/activity: initializing");var t=r("#page-local-excursions-activity");t.length?new e(t).main():d.error("local_excursions/activities: #page-local-excursions-activity not found!")}}});